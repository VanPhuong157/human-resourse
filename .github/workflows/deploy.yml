name: Deploy to Viettel VPS
on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: SSH and Deploy
        uses: appleboy/ssh-action@master
        with:
          host: 27.71.26.109
          username: root
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            cd ~/human-resourse
            git fetch --all
            git reset --hard origin/main
            git clean -fd
            
            if [ -f "docker-compose.yml" ]; then
                # Bước 1: Chỉ build lại image mới cho Backend và Frontend
                docker-compose build backend_api frontend_ui
                
                # Bước 2: Restart FE/BE mà KHÔNG dừng (stop/remove) sql_server
                # Lệnh này sẽ giữ sql_server chạy liên tục
                docker-compose up -d --no-deps backend_api frontend_ui
                
                # Bước 3: Dọn dẹp các image cũ để đỡ đầy bộ nhớ server
                docker image prune -f
            else
                echo "LỖI: Không tìm thấy file docker-compose.yml"
                exit 1
            fi
